---
# Main playbook to configure infrastructure provisioned by Terraform
# Triggered by EDA rulebook when Terraform posts infrastructure_provisioned event

- name: Display Terraform Event Context
  hosts: localhost
  connection: local
  gather_facts: no
  become: no
  
  tasks:
    - name: Display Terraform context
      debug:
        msg:
          - "========================================="
          - "Terraform Infrastructure Configuration"
          - "========================================="
          - "Workspace: {{ terraform_workspace }}"
          - "Organization: {{ terraform_organization }}"
          - "Run ID: {{ terraform_run_id }}"
          - "VPC ID: {{ vpc_id }}"
          - "VPC CIDR: {{ vpc_cidr }}"
          - "Region: {{ aws_region }}"
          - "Environment: {{ environment }}"
          - "Instance Count: {{ instances | length }}"
          - "========================================="
    
    - name: Debug Vault environment variables
      debug:
        msg:
          - "VAULT_ADDR: {{ lookup('env', 'VAULT_ADDR') }}"
          - "VAULT_NAMESPACE (env): {{ lookup('env', 'VAULT_NAMESPACE') }}"
          - "VAULT_NAMESPACE (var): {{ vault_namespace }}"
          - "VAULT_ROLE_ID: {{ lookup('env', 'VAULT_ROLE_ID')[:8] }}..."
          - "VAULT_SECRET_ID: {{ 'SET' if lookup('env', 'VAULT_SECRET_ID') else 'NOT SET' }}"

    - name: Authenticate to HCP Vault using AppRole
      uri:
        url: "{{ lookup('env', 'VAULT_ADDR') | regex_replace('/$', '') }}/v1/auth/approle/login"
        method: POST
        body_format: json
        headers:
          X-Vault-Namespace: "{{ vault_namespace }}"
        body:
          role_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"
          secret_id: "{{ lookup('env', 'VAULT_SECRET_ID') }}"
        status_code: 200
      register: vault_login
      no_log: false
    
    - name: Set Vault token fact
      set_fact:
        vault_token: "{{ vault_login.json.auth.client_token }}"
      no_log: true
    
    - name: Fetch application secrets from HCP Vault
      uri:
        url: "{{ lookup('env', 'VAULT_ADDR') | regex_replace('/$', '') }}/v1/secret/data/applications/demo-app"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
          X-Vault-Namespace: "{{ vault_namespace }}"
        status_code: 200
      register: app_secrets
      no_log: true
    
    - name: Set application secrets as facts
      set_fact:
        database_url: "{{ app_secrets.json.data.data.database_url }}"
        api_key: "{{ app_secrets.json.data.data.api_key }}"
      no_log: true
    
    - name: Build in-memory inventory from Terraform event
      add_host:
        name: "{{ item.name }}"
        groups:
          - app_servers
          - aws_ec2
        ansible_host: "{{ item.public_ip }}"
        instance_id: "{{ item.id }}"
        private_ip: "{{ item.private_ip }}"
        public_ip: "{{ item.public_ip }}"
        subnet_id: "{{ item.subnet_id }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
      loop: "{{ instances }}"
      loop_control:
        label: "{{ item.name }}"
    
    - name: Wait for instances to be ready
      wait_for:
        host: "{{ item.public_ip }}"
        port: 22
        delay: 10
        timeout: 300
        state: started
      loop: "{{ instances }}"
      loop_control:
        label: "{{ item.name }}"

- name: Configure EC2 Instances
  hosts: app_servers
  gather_facts: yes
  become: yes
  
  vars:
    vault_token: "{{ hostvars['localhost']['vault_token'] }}"
    vault_address: "{{ lookup('env', 'VAULT_ADDR') | regex_replace('/$', '') }}"
    vault_namespace: "{{ vault_namespace }}"
    database_url: "{{ hostvars['localhost']['database_url'] }}"
    api_key: "{{ hostvars['localhost']['api_key'] }}"
  
  tasks:
    - name: Display instance information
      debug:
        msg:
          - "Configuring: {{ inventory_hostname }}"
          - "Instance ID: {{ instance_id }}"
          - "Private IP: {{ private_ip }}"
          - "Public IP: {{ public_ip }}"
    
    - name: Update system packages
      yum:
        name: '*'
        state: latest
      register: yum_update
      retries: 3
      delay: 10
    
    - name: Install required packages
      yum:
        name:
          - docker
          - python3
          - python3-pip
          - git
          - vim
          - htop
          - jq
          - nc
        state: present
    
    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes
    
    - name: Add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes
    
    - name: Create application directory
      file:
        path: /opt/demo-app
        state: directory
        mode: '0755'
        owner: ec2-user
        group: ec2-user
    
    - name: Create configuration directory
      file:
        path: /etc/demo-app
        state: directory
        mode: '0755'
    
    - name: Deploy application configuration
      copy:
        content: |
          # Demo Application Configuration
          # Generated by Ansible from Terraform event
          
          # Terraform Context
          TERRAFORM_RUN_ID={{ hostvars['localhost']['terraform_run_id'] }}
          TERRAFORM_WORKSPACE={{ hostvars['localhost']['terraform_workspace'] }}
          
          # Infrastructure Details
          VPC_ID={{ hostvars['localhost']['vpc_id'] }}
          AWS_REGION={{ hostvars['localhost']['aws_region'] }}
          ENVIRONMENT={{ hostvars['localhost']['environment'] }}
          
          # Instance Details
          INSTANCE_ID={{ instance_id }}
          PRIVATE_IP={{ ansible_host }}
          PUBLIC_IP={{ public_ip }}
          
          # Application Secrets (from HCP Vault)
          DATABASE_URL={{ database_url }}
          API_KEY={{ api_key }}
        dest: /etc/demo-app/config.env
        mode: '0600'
        owner: root
        group: root
    
    - name: Create application service file
      copy:
        content: |
          [Unit]
          Description=Demo Application - Nginx Web Server
          After=docker.service
          Requires=docker.service
          
          [Service]
          Type=simple
          User=ec2-user
          EnvironmentFile=/etc/demo-app/config.env
          ExecStart=/usr/bin/docker run --rm --name demo-app \
            -p 8080:80 \
            -v /etc/demo-app:/usr/share/nginx/html:ro \
            nginx:alpine
          ExecStop=/usr/bin/docker stop demo-app
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/demo-app.service
        mode: '0644'
      notify: Reload systemd
    
    - name: Create demo HTML page
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Red Hat + HashiCorp Demo</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                  .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  h1 { color: #ee0000; }
                  .info { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 4px; }
                  .success { color: #00aa00; font-weight: bold; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üéâ Red Hat + HashiCorp Integration Demo</h1>
                  <p class="success">‚úÖ Integration Successfully Deployed!</p>
                  
                  <h2>Instance Information</h2>
                  <div class="info">
                      <strong>Hostname:</strong> {{ inventory_hostname }}<br>
                      <strong>Instance ID:</strong> {{ instance_id }}<br>
                      <strong>Private IP:</strong> {{ private_ip }}<br>
                      <strong>Public IP:</strong> {{ public_ip }}
                  </div>
                  
                  <h2>Integration Components</h2>
                  <ul>
                      <li>‚úÖ Terraform (HCP Terraform) - Infrastructure provisioning</li>
                      <li>‚úÖ Ansible Automation Platform - Configuration management</li>
                      <li>‚úÖ HCP Vault - Secrets management</li>
                      <li>‚úÖ AWS EC2 - Cloud infrastructure</li>
                      <li>‚úÖ Docker - Container runtime</li>
                  </ul>
                  
                  <h2>Secrets Retrieved from Vault</h2>
                  <div class="info">
                      <strong>Database URL:</strong> {{ database_url }}<br>
                      <strong>API Key:</strong> {{ api_key[:8] }}...
                  </div>
                  
                  <p><em>This page was automatically deployed by Ansible Automation Platform using secrets from HCP Vault!</em></p>
              </div>
          </body>
          </html>
        dest: /etc/demo-app/index.html
        mode: '0644'
    
    - name: Create validation script
      copy:
        content: |
          #!/bin/bash
          # Validation script for demo application
          
          echo "Validating configuration..."
          
          # Check if config file exists
          if [ ! -f /etc/demo-app/config.env ]; then
            echo "ERROR: Configuration file not found"
            exit 1
          fi
          
          # Check if Docker is running
          if ! systemctl is-active --quiet docker; then
            echo "ERROR: Docker is not running"
            exit 1
          fi
          
          # Check if port 8080 is available
          if netstat -tuln | grep -q ':8080 '; then
            echo "WARNING: Port 8080 is already in use"
          fi
          
          echo "Configuration validation passed"
          exit 0
        dest: /usr/local/bin/validate-config.sh
        mode: '0755'
    
    - name: Validate configuration
      command: /usr/local/bin/validate-config.sh
      register: validation
      changed_when: false
      failed_when: validation.rc != 0
    
    - name: Enable and start demo application service
      systemd:
        name: demo-app
        state: started
        enabled: yes
        daemon_reload: yes
    
    - name: Wait for application to be ready
      wait_for:
        port: 8080
        delay: 5
        timeout: 60
        state: started
    
    - name: Test application endpoint
      uri:
        url: "http://localhost:8080/"
        method: GET
        status_code: 200
      register: health_check
      retries: 5
      delay: 10
      until: health_check.status == 200
      ignore_errors: yes
    
    - name: Display health check result
      debug:
        msg: "Application health check: {{ 'PASSED ‚úÖ' if health_check.status == 200 else 'FAILED ‚ùå' }}"
    
    - name: Display application URLs
      debug:
        msg:
          - "========================================="
          - "‚úÖ Infrastructure Configuration Complete!"
          - "========================================="
          - "Application URLs:"
          - "{% for instance in instances %}"
          - "  - http://{{ instance.public_ip }}:8080"
          - "{% endfor %}"
          - ""
          - "Instance Details:"
          - "{% for instance in instances %}"
          - "  {{ instance.name }}:"
          - "    Public IP: {{ instance.public_ip }}"
          - "    Private IP: {{ instance.private_ip }}"
          - "    Instance ID: {{ instance.id }}"
          - "{% endfor %}"
          - "========================================="
  
  handlers:
    - name: Reload systemd
      systemd:
        daemon_reload: yes

- name: Deploy to OpenShift
  import_playbook: deploy-to-openshift.yml
  vars:
    openshift_namespace: "steveweaver-hashi"
    application_name: "terraform-demo"
    replicas: 1
    environment: "demo"

# Made with Bob
