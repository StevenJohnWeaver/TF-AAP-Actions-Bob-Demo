---
# Deploy application to OpenShift
# This playbook is triggered after infrastructure configuration is complete

- name: Deploy Application to OpenShift
  hosts: localhost
  connection: local
  gather_facts: no
  
  vars:
    # Default values - will be overridden by Vault secrets
    openshift_api_url: ""
    openshift_token: ""
    openshift_namespace: "steveweaver-hashi"
    
  tasks:
    - name: Display deployment context
      debug:
        msg:
          - "========================================="
          - "OpenShift Application Deployment"
          - "========================================="
          - "Terraform Run ID: {{ terraform_run_id }}"
          - "Workspace: {{ terraform_workspace }}"
          - "VPC ID: {{ vpc_id }}"
          - "AWS Region: {{ aws_region }}"
          - "Backend Instances: {{ instances | length }}"
          - "Namespace: {{ openshift_namespace }}"
          - "Application: {{ application_name }}"
          - "Replicas: {{ replicas }}"
          - "========================================="
    
    - name: Authenticate to HCP Vault
      uri:
        url: "{{ vault_address }}/v1/auth/approle/login"
        method: POST
        body_format: json
        headers:
          X-Vault-Namespace: "{{ vault_namespace }}"
        body:
          role_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"
          secret_id: "{{ lookup('env', 'VAULT_SECRET_ID') }}"
        status_code: 200
      register: vault_login
      no_log: true
    
    - name: Set Vault token
      set_fact:
        vault_token: "{{ vault_login.json.auth.client_token }}"
      no_log: true
    
    - name: Fetch OpenShift credentials from HCP Vault
      uri:
        url: "{{ vault_address | regex_replace('/$', '') }}/v1/secret/data/openshift/credentials"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
          X-Vault-Namespace: "{{ vault_namespace }}"
        status_code: 200
      register: ocp_creds
      no_log: true
    
    - name: Set OpenShift connection details
      set_fact:
        openshift_api_url: "{{ ocp_creds.json.data.data.api_url }}"
        openshift_token: "{{ ocp_creds.json.data.data.token }}"
        openshift_namespace: "{{ ocp_creds.json.data.data.namespace }}"
      no_log: true
    
    - name: Verify OpenShift API connectivity
      uri:
        url: "{{ openshift_api_url }}/apis"
        method: GET
        headers:
          Authorization: "Bearer {{ openshift_token }}"
        validate_certs: no
        status_code: 200
      register: api_check
      ignore_errors: yes
    
    - name: Display API check result
      debug:
        msg: "OpenShift API connectivity: {{ 'SUCCESS ‚úÖ' if api_check.status == 200 else 'FAILED ‚ùå' }}"
    
    - name: Verify namespace exists (OpenShift Sandbox uses pre-created namespace)
      uri:
        url: "{{ openshift_api_url }}/api/v1/namespaces/{{ openshift_namespace }}"
        method: GET
        headers:
          Authorization: "Bearer {{ openshift_token }}"
        validate_certs: no
        status_code: 200
      register: namespace_check
      ignore_errors: yes
    
    - name: Display namespace status
      debug:
        msg: "Using namespace: {{ openshift_namespace }} ({{ 'exists ‚úÖ' if namespace_check.status == 200 else 'not found ‚ùå' }})"
    
    - name: Fetch application secrets from HCP Vault
      uri:
        url: "{{ vault_address }}/v1/secret/data/applications/demo-app"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
          X-Vault-Namespace: "{{ vault_namespace }}"
        status_code: 200
      register: app_secrets
      no_log: true
    
    - name: Create backend IPs list
      set_fact:
        backend_ips: "{{ instances | map(attribute='private_ip') | join(',') }}"
        backend_ids: "{{ instances | map(attribute='id') | join(',') }}"
    
    - name: Create HTML content for nginx
      set_fact:
        nginx_html: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Red Hat + HashiCorp Integration Demo - OpenShift</title>
              <style>
                  body { font-family: Arial, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
                  .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  h1 { color: #ee0000; border-bottom: 3px solid #ee0000; padding-bottom: 10px; }
                  h2 { color: #333; margin-top: 30px; }
                  .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 4px; margin: 20px 0; }
                  .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
                  .info-card { background: #f8f9fa; padding: 15px; border-radius: 4px; border-left: 4px solid #007bff; }
                  .info-card h3 { margin-top: 0; color: #007bff; }
                  .secret-value { font-family: monospace; background: #e9ecef; padding: 5px 10px; border-radius: 3px; }
                  .component { display: inline-block; background: #007bff; color: white; padding: 5px 15px; margin: 5px; border-radius: 20px; }
                  ul { line-height: 1.8; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üéâ Red Hat + HashiCorp Integration Demo</h1>
                  <div class="success">
                      <strong>‚úÖ Successfully Deployed to OpenShift!</strong><br>
                      This application demonstrates the complete integration between Red Hat Ansible Automation Platform,
                      HashiCorp Terraform Cloud, and HashiCorp Vault running on OpenShift.
                  </div>
                  
                  <h2>üèóÔ∏è Infrastructure Details</h2>
                  <div class="info-grid">
                      <div class="info-card">
                          <h3>OpenShift</h3>
                          <ul>
                              <li><strong>Namespace:</strong> {{ openshift_namespace }}</li>
                              <li><strong>Application:</strong> {{ application_name }}</li>
                              <li><strong>Replicas:</strong> {{ replicas }}</li>
                          </ul>
                      </div>
                      <div class="info-card">
                          <h3>AWS Infrastructure</h3>
                          <ul>
                              <li><strong>VPC ID:</strong> {{ vpc_id }}</li>
                              <li><strong>Region:</strong> {{ aws_region }}</li>
                              <li><strong>Backend Instances:</strong> {{ instances | length }}</li>
                              <li><strong>Backend IPs:</strong> {{ backend_ips }}</li>
                          </ul>
                      </div>
                      <div class="info-card">
                          <h3>Terraform</h3>
                          <ul>
                              <li><strong>Run ID:</strong> {{ terraform_run_id }}</li>
                              <li><strong>Workspace:</strong> {{ terraform_workspace }}</li>
                          </ul>
                      </div>
                  </div>
                  
                  <h2>üîê Secrets from HashiCorp Vault</h2>
                  <div class="info-card">
                      <p>Successfully retrieved application secrets from HCP Vault:</p>
                      <ul>
                          <li><strong>Database URL:</strong> <span class="secret-value">{{ app_secrets.json.data.data.database_url }}</span></li>
                          <li><strong>API Key:</strong> <span class="secret-value">{{ app_secrets.json.data.data.api_key[:8] }}...</span></li>
                      </ul>
                  </div>
                  
                  <h2>üîó Integration Components</h2>
                  <div style="margin: 20px 0;">
                      <span class="component">Terraform Cloud</span>
                      <span class="component">Ansible AAP</span>
                      <span class="component">HCP Vault</span>
                      <span class="component">AWS EC2</span>
                      <span class="component">OpenShift</span>
                  </div>
                  
                  <h2>üìã Deployment Flow</h2>
                  <ol>
                      <li>Terraform provisions AWS infrastructure (VPC, EC2 instances)</li>
                      <li>Terraform triggers Ansible Automation Platform job</li>
                      <li>AAP authenticates to HCP Vault using AppRole</li>
                      <li>AAP retrieves secrets from Vault</li>
                      <li>AAP configures EC2 instances</li>
                      <li>AAP deploys application to OpenShift</li>
                      <li>Application running with secrets from Vault ‚úÖ</li>
                  </ol>
              </div>
          </body>
          </html>
    
    - name: Create ConfigMap with nginx HTML content
      kubernetes.core.k8s:
        api_key: "{{ openshift_token }}"
        host: "{{ openshift_api_url }}"
        validate_certs: no
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: nginx-html
            namespace: "{{ openshift_namespace }}"
            labels:
              app: "{{ application_name }}"
          data:
            index.html: "{{ nginx_html }}"
    
    - name: Create OpenShift secret with application credentials
      kubernetes.core.k8s:
        api_key: "{{ openshift_token }}"
        host: "{{ openshift_api_url }}"
        validate_certs: no
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: app-secrets
            namespace: "{{ openshift_namespace }}"
            labels:
              terraform-run-id: "{{ terraform_run_id }}"
              app: "{{ application_name }}"
          type: Opaque
          stringData:
            database-url: "{{ app_secrets.json.data.data.database_url }}"
            api-key: "{{ app_secrets.json.data.data.api_key }}"
            backend-ips: "{{ backend_ips }}"
    
    - name: Create ConfigMap with infrastructure details
      kubernetes.core.k8s:
        api_key: "{{ openshift_token }}"
        host: "{{ openshift_api_url }}"
        validate_certs: no
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: infrastructure-config
            namespace: "{{ openshift_namespace }}"
            labels:
              terraform-run-id: "{{ terraform_run_id }}"
              app: "{{ application_name }}"
          data:
            vpc_id: "{{ vpc_id }}"
            vpc_cidr: "{{ vpc_cidr | default('N/A') }}"
            aws_region: "{{ aws_region }}"
            environment: "{{ environment | default('demo') }}"
            terraform_run_id: "{{ terraform_run_id }}"
            terraform_workspace: "{{ terraform_workspace }}"
            backend_instance_ids: "{{ backend_ids }}"
            backend_instance_ips: "{{ backend_ips }}"
            backend_instance_count: "{{ instances | length }}"
    
    - name: Deploy application
      kubernetes.core.k8s:
        api_key: "{{ openshift_token }}"
        host: "{{ openshift_api_url }}"
        validate_certs: no
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: "{{ application_name }}"
            namespace: "{{ openshift_namespace }}"
            labels:
              app: "{{ application_name }}"
              terraform-run-id: "{{ terraform_run_id }}"
              managed-by: "terraform-aap"
          spec:
            replicas: "{{ replicas | int }}"
            selector:
              matchLabels:
                app: "{{ application_name }}"
            template:
              metadata:
                labels:
                  app: "{{ application_name }}"
                  terraform-run-id: "{{ terraform_run_id }}"
                  version: "v1"
              spec:
                containers:
                - name: nginx
                  image: nginx:alpine
                  imagePullPolicy: Always
                  ports:
                  - containerPort: 80
                    name: http
                    protocol: TCP
                  env:
                  - name: DATABASE_URL
                    valueFrom:
                      secretKeyRef:
                        name: app-secrets
                        key: database-url
                  - name: API_KEY
                    valueFrom:
                      secretKeyRef:
                        name: app-secrets
                        key: api-key
                  - name: BACKEND_IPS
                    valueFrom:
                      secretKeyRef:
                        name: app-secrets
                        key: backend-ips
                  - name: VPC_ID
                    valueFrom:
                      configMapKeyRef:
                        name: infrastructure-config
                        key: vpc_id
                  - name: AWS_REGION
                    valueFrom:
                      configMapKeyRef:
                        name: infrastructure-config
                        key: aws_region
                  - name: TERRAFORM_RUN_ID
                    valueFrom:
                      configMapKeyRef:
                        name: infrastructure-config
                        key: terraform_run_id
                  - name: ENVIRONMENT
                    valueFrom:
                      configMapKeyRef:
                        name: infrastructure-config
                        key: environment
                  volumeMounts:
                  - name: html-content
                    mountPath: /usr/share/nginx/html
                  resources:
                    requests:
                      memory: "64Mi"
                      cpu: "100m"
                    limits:
                      memory: "128Mi"
                      cpu: "200m"
                volumes:
                - name: html-content
                  configMap:
                    name: nginx-html
    
    - name: Create Service
      kubernetes.core.k8s:
        api_key: "{{ openshift_token }}"
        host: "{{ openshift_api_url }}"
        validate_certs: no
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ application_name }}"
            namespace: "{{ openshift_namespace }}"
            labels:
              app: "{{ application_name }}"
              terraform-run-id: "{{ terraform_run_id }}"
          spec:
            selector:
              app: "{{ application_name }}"
            ports:
            - name: http
              port: 80
              targetPort: 80
              protocol: TCP
            type: ClusterIP
    
    - name: Create Route
      kubernetes.core.k8s:
        api_key: "{{ openshift_token }}"
        host: "{{ openshift_api_url }}"
        validate_certs: no
        state: present
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: "{{ application_name }}"
            namespace: "{{ openshift_namespace }}"
            labels:
              app: "{{ application_name }}"
              terraform-run-id: "{{ terraform_run_id }}"
          spec:
            to:
              kind: Service
              name: "{{ application_name }}"
              weight: 100
            port:
              targetPort: http
            tls:
              termination: edge
              insecureEdgeTerminationPolicy: Redirect
            wildcardPolicy: None
    
    - name: Wait for deployment to be ready
      kubernetes.core.k8s_info:
        api_key: "{{ openshift_token }}"
        host: "{{ openshift_api_url }}"
        validate_certs: no
        kind: Deployment
        name: "{{ application_name }}"
        namespace: "{{ openshift_namespace }}"
      register: deployment
      until: >
        deployment.resources | length > 0 and
        deployment.resources[0].status.readyReplicas is defined and
        deployment.resources[0].status.readyReplicas == (replicas | int)
      retries: 30
      delay: 10
    
    - name: Get application route
      kubernetes.core.k8s_info:
        api_key: "{{ openshift_token }}"
        host: "{{ openshift_api_url }}"
        validate_certs: no
        kind: Route
        name: "{{ application_name }}"
        namespace: "{{ openshift_namespace }}"
      register: route
    
    - name: Get pod information
      kubernetes.core.k8s_info:
        api_key: "{{ openshift_token }}"
        host: "{{ openshift_api_url }}"
        validate_certs: no
        kind: Pod
        namespace: "{{ openshift_namespace }}"
        label_selectors:
          - "app={{ application_name }}"
      register: pods
    
    - name: Display deployment success
      debug:
        msg:
          - "========================================="
          - "‚úÖ Deployment Successful!"
          - "========================================="
          - "Application URL: https://{{ route.resources[0].spec.host }}"
          - "Namespace: {{ openshift_namespace }}"
          - "Replicas: {{ deployment.resources[0].status.readyReplicas }}/{{ replicas }}"
          - "Pods:"
          - "{{ pods.resources | map(attribute='metadata.name') | list }}"
          - ""
          - "Infrastructure Details:"
          - "  Terraform Run ID: {{ terraform_run_id }}"
          - "  VPC ID: {{ vpc_id }}"
          - "  AWS Region: {{ aws_region }}"
          - "  Backend Instances: {{ instances | length }}"
          - "  Backend IPs: {{ backend_ips }}"
          - "========================================="
    
    - name: Test application endpoint
      uri:
        url: "https://{{ route.resources[0].spec.host }}/"
        method: GET
        validate_certs: no
        status_code: 200
      register: health_check
      retries: 5
      delay: 10
      until: health_check.status == 200
      ignore_errors: yes
    
    - name: Display health check result
      debug:
        msg: "Application health check: {{ 'PASSED ‚úÖ' if health_check.status == 200 else 'FAILED ‚ùå' }}"

# Made with Bob
